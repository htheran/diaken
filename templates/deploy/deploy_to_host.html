{% extends 'base/base.html' %}
{% block page_title %}Deploy to Host{% endblock %}
{% block content %}
  <div class="container mt-4">
    <h2>Deploy to Host</h2>
    <form method="post" id="deploy-form">
      {% csrf_token %}
      <div class="form-group">
        <label for="environment">Select Environment:</label>
        <select class="form-control" id="environment" name="environment">
          <option value="">Select Environment</option>
          {% for environment in environments %}
            <option value="{{ environment.id }}">{{ environment.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="group">Select Group:</label>
        <select class="form-control" id="group" name="group" disabled>
          <option value="">Select Group</option>
        </select>
      </div>
      <div class="form-group">
        <label for="host">Select Host:</label>
        <select class="form-control" id="host" name="host" disabled>
          <option value="">Select Host</option>
        </select>
      </div>
      <div class="form-group">
        <label for="playbook">Select Playbook:</label>
        <select class="form-control" id="playbook" name="playbook">
          <option value="">Select Playbook</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Deploy</button>
    </form>
    <div id="progress-bar" style="display:none; text-align:center; margin-top:20px;">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Cargando...</span>
      </div>
      <p style="margin-top:10px;">Running playbook, please wait...</p>
    </div>
  </div>

  <script>
    // Mostrar spinner al enviar el formulario
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('deploy-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          document.getElementById('progress-bar').style.display = 'block';
          e.preventDefault();
          setTimeout(() => form.submit(), 50);
        });
      }
    });

    document.getElementById('environment').addEventListener('change', function() {
      var environmentId = this.value;
      fetch(`/deploy/api/groups/?environment_id=${environmentId}`)
        .then(response => response.json())
        .then(data => {
          var groupSelect = document.getElementById('group');
          groupSelect.innerHTML = '<option value="">Select Group</option>';
          data.groups.forEach(group => {
            groupSelect.innerHTML += `<option value="${group.id}">${group.name}</option>`;
          });
          groupSelect.disabled = false;
        });
    });

    document.getElementById('group').addEventListener('change', function() {
      var groupId = this.value;
      fetch(`/deploy/api/hosts/?group_id=${groupId}`)
        .then(response => response.json())
        .then(data => {
          var hostSelect = document.getElementById('host');
          hostSelect.innerHTML = '<option value="">Select Host</option>';
          data.hosts.forEach(host => {
            hostSelect.innerHTML += `<option value="${host.id}">${host.name}</option>`;
          });
          hostSelect.disabled = false;
          // Vac√≠a el select de playbooks hasta que se seleccione un host
          var playbookSelect = document.getElementById('playbook');
          playbookSelect.innerHTML = '<option value="">Select Playbook</option>';
        });
    });

    // Actualiza playbooks cuando se selecciona un host
    document.getElementById('host').addEventListener('change', function() {
      var hostId = this.value;
      var playbookSelect = document.getElementById('playbook');
      playbookSelect.innerHTML = '<option value="">Select Playbook</option>';
      if (hostId) {
        fetch(`/deploy/api/playbooks/?host_id=${hostId}`)
          .then(response => response.json())
          .then(data => {
            if (data.playbooks && data.playbooks.length > 0) {
              data.playbooks.forEach(pb => {
                var opt = document.createElement('option');
                opt.value = pb.id;
                opt.textContent = pb.name;
                playbookSelect.appendChild(opt);
              });
            }
          });
      }
    });
  </script>
{% endblock %}
