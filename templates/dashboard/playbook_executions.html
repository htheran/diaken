{% extends 'base/base.html' %}
{% load static %}
{% block page_title %}Playbook Executions{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Playbook Executions</h2>
  <div class="d-flex justify-content-center" style="padding-bottom: 2rem;">
    <canvas id="executionsHistogram" height="180" style="max-width: 700px;"></canvas>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  let labels = {{ labels|safe }};
  let datasets = {{ datasets|safe }};
  let ctx = document.getElementById('executionsHistogram').getContext('2d');

  function updateChartData(newLabels, newDatasets) {
    executionsChart.data.labels = newLabels;
    executionsChart.data.datasets = newDatasets.map(ds => ({
      ...ds,
      borderWidth: 2,
      borderColor: ds.borderColor || '#222',
      backgroundColor: ds.backgroundColor,
      barPercentage: 0.6,
      categoryPercentage: 0.6,
    }));
    let allValues = newDatasets.flatMap(ds => ds.data);
    let maxValue = Math.max(...allValues, 1);
    executionsChart.options.scales.y.suggestedMax = Math.ceil(maxValue * 1.2);
    executionsChart.update();
  }

  // Auto-refresh cada 15 segundos
  setInterval(function() {
    fetch(window.location.pathname + '?ajax=1')
      .then(resp => resp.json())
      .then(data => {
        updateChartData(data.labels, data.datasets);
      });
  }, 15000);

  // Calcular el valor máximo de todas las barras para sugerir un límite superior cómodo
  let allValues = datasets.flatMap(ds => ds.data);
  let maxValue = Math.max(...allValues, 1); // evitar 0
  let suggestedMax = Math.ceil(maxValue * 1.2);

  let executionsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets.map(ds => ({
        ...ds,
        borderWidth: 2,
        borderColor: '#222',
        backgroundColor: ds.backgroundColor,
        barPercentage: 0.6,
        categoryPercentage: 0.6,
      }))
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { font: { size: 16 }, color: '#222' }
        },
        title: {
          display: true,
          text: 'Ejecuciones de Playbooks por Día',
          font: { size: 28, weight: 'bold' },
          color: '#222',
          align: 'center',
          padding: { top: 10, bottom: 30 }
        },
        datalabels: {
          display: true,
          color: '#222',
          font: { weight: 'bold', size: 16 },
          anchor: 'end',
          align: 'top',
          backgroundColor: '#fff',
          borderRadius: 3,
          padding: 3,
          formatter: Math.round
        },
        tooltip: {
          enabled: true,
          backgroundColor: '#222',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#fff',
          borderWidth: 1
        }
      },
      layout: {
        padding: { left: 10, right: 10, top: 10, bottom: 10 }
      },
      scales: {
        x: {
          title: { display: true, text: 'Fecha', font: { size: 18, weight: 'bold' }, color: '#222' },
          ticks: { font: { size: 15 }, color: '#222' },
          grid: { display: false },
          stacked: true,
          categoryPercentage: 0.6,
          barPercentage: 0.6
        },
        y: {
          beginAtZero: true,
          suggestedMax: suggestedMax,
          stacked: true,
          title: { display: true, text: 'Ejecuciones', font: { size: 18, weight: 'bold' }, color: '#222' },
          ticks: { font: { size: 15 }, color: '#222', stepSize: 1 },
          grid: { color: '#bbb', borderDash: [3, 2] }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
</script>
{% endblock %}
