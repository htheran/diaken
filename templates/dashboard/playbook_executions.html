{% extends 'base/base.html' %}
{% load static %}
{% block page_title %}Playbook Executions{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card card-primary card-outline">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-chart-bar mr-2"></i> Ejecuciones de Playbooks</h3>
    </div>
    <div class="card-body">
      <div class="chart">
        <canvas id="executionsHistogram" style="width:100%;height:320px;"></canvas>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  let labels = {{ labels|safe }};
  let datasets = {{ datasets|safe }};
  let ctx = document.getElementById('executionsHistogram').getContext('2d');

  function updateChartData(newLabels, newDatasets) {
    executionsChart.data.labels = newLabels;
    executionsChart.data.datasets = newDatasets.map(ds => ({
      ...ds,
      borderWidth: 2,
      borderRadius: 8,
      borderColor: ds.borderColor || '#222',
      backgroundColor: ds.backgroundColor,
      barPercentage: 0.6,
      categoryPercentage: 0.6,
    }));
    let allValues = newDatasets.flatMap(ds => ds.data);
    let maxValue = Math.max(...allValues, 1);
    executionsChart.options.scales.y.suggestedMax = Math.ceil(maxValue * 1.2);
    executionsChart.update();
  }

  // Auto-refresh cada 15 segundos
  setInterval(function() {
    fetch(window.location.pathname + '?ajax=1')
      .then(resp => resp.json())
      .then(data => {
        updateChartData(data.labels, data.datasets);
      });
  }, 15000);

  let allValues = datasets.flatMap(ds => ds.data);
  let maxValue = Math.max(...allValues, 1); // evitar 0
  let suggestedMax = Math.ceil(maxValue * 1.2);

  let executionsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      // Paleta de 20 colores distintos (tipo d3.schemeCategory20)
      datasets: datasets.map((ds, i) => {
        const palette = [
          '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
          '#393b79', '#637939', '#8c6d31', '#843c39', '#7b4173', '#5254a3', '#9c9ede', '#cedb9c', '#e7ba52', '#ad494a'
        ];
        return {
          ...ds,
          borderWidth: 2,
          borderRadius: 8,
          borderColor: palette[i % palette.length],
          backgroundColor: palette[i % palette.length],
          barPercentage: 0.6,
          categoryPercentage: 0.6,
        };
      })
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          align: 'start',
          labels: {
            font: { size: 13, family: 'Segoe UI, Arial, sans-serif', weight: 'bold' },
            color: '#222',
            padding: 10,
            boxWidth: 18,
            boxHeight: 14,
            usePointStyle: true,
            textAlign: 'left',
            generateLabels: function(chart) {
              // Cada métrica en una línea
              const datasets = chart.data.datasets || [];
              return datasets.map((ds, i) => ({
                text: ds.label,
                fillStyle: ds.backgroundColor,
                strokeStyle: ds.borderColor,
                lineWidth: 2,
                hidden: !chart.isDatasetVisible(i),
                index: i
              }));
            }
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: '#222',
          font: { weight: 'bold', size: 16, family: 'Segoe UI, Arial, sans-serif' },
          formatter: Math.round,
          padding: 4
        },
        title: {
          display: false
        },
        tooltip: {
          enabled: true,
          backgroundColor: '#222',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#fff',
          borderWidth: 1,
          padding: 12,
          titleFont: { size: 17, weight: 'bold' },
          bodyFont: { size: 15 }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 16, family: 'Segoe UI, Arial, sans-serif' }, color: '#222' }
        },
        y: {
          beginAtZero: true,
          max: 14,
          grid: { color: '#eee' },
          ticks: { font: { size: 16, family: 'Segoe UI, Arial, sans-serif' }, color: '#222' }
        }
      },
      layout: {
        padding: 30
      },
      backgroundColor: '#f9fafd'
    },
    plugins: [ChartDataLabels]
  });
</script>
{% endblock %}
