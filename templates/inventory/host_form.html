{% extends 'base/base.html' %}
{% block content %}
  <div class="container mt-4">
    <div class="card">
      <div class="card-header">
        <h2>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Host</h2>
      </div>
      <div class="card-body">
        <form method="post">
  {% csrf_token %}
  <div class="form-group">
    {{ form.environment.label_tag }}
    <select name="environment" class="form-control" id="id_environment">
      <option value="">-------------</option>
      {% for env in form.fields.environment.queryset %}
        <option value="{{ env.pk }}" {% if form.initial.environment == env.pk %}selected{% endif %}>{{ env.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group">
    {{ form.group.label_tag }}
    <select name="group" class="form-control" id="id_group">
      <option value="">-------------</option>
      {% for grp in form.fields.group.queryset %}
        <option value="{{ grp.pk }}" data-environment-id="{{ grp.environment.pk }}" {% if form.initial.group == grp.pk %}selected{% endif %}>{{ grp.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group">
    {{ form.name.label_tag }} {{ form.name }}
  </div>
  <div class="form-group">
    {{ form.ip.label_tag }} {{ form.ip }}
  </div>
  <div class="form-group">
    {{ form.operating_system.label_tag }}
    <select name="operating_system" class="form-control" id="id_operating_system">
      <option value="">-------------</option>
      {% for value, label in form.fields.operating_system.choices %}
        <option value="{{ value }}" {% if form.initial.operating_system == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group" id="py-interpreter-group">
    {{ form.ansible_python_interpreter.label_tag }} {{ form.ansible_python_interpreter }}
  </div>
  {# DEPURACIÓN: Mostrar credenciales en queryset #}


  <div class="form-group" id="cred-group">
    {{ form.deployment_credential.label_tag }}
    <select name="deployment_credential" class="form-control" id="id_deployment_credential">
      <option value="" {% if not form.initial.deployment_credential %}selected{% endif %}>-------------</option>
      {% for cred in form.fields.deployment_credential.queryset %}
        <option value="{{ cred.pk }}" {% if form.initial.deployment_credential == cred.pk %}selected{% endif %}>{{ cred.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div id="windows-fields" style="display:none;">
    <div class="form-group">
      {{ form.ansible_user.label_tag }} {{ form.ansible_user }}
    </div>
    <div class="form-group">
      {{ form.ansible_password.label_tag }} {{ form.ansible_password }}
    </div>
  </div>
  <div class="form-group">
    {{ form.status.label_tag }} {{ form.status }}
  </div>
  <div class="form-group">
    {{ form.tags.label_tag }} {{ form.tags }}
  </div>
  <div class="form-group">
    {{ form.notes.label_tag }} {{ form.notes }}
  </div>
<script>
function updateFormByOS() {
  var os = document.getElementById('id_operating_system').value;
  var credGroup = document.getElementById('cred-group');
  var winFields = document.getElementById('windows-fields');
  if (os === 'Windows') {
    credGroup.style.display = 'none';
    winFields.style.display = '';
  } else {
    credGroup.style.display = '';
    winFields.style.display = 'none';
  }
}
document.getElementById('id_operating_system').addEventListener('change', updateFormByOS);
window.onload = updateFormByOS;
</script>

  var os = document.getElementById('id_operating_system').value;
  var winFields = document.getElementById('windows-fields');
  if (os === 'Windows') {
    winFields.style.display = '';
  } else {
    winFields.style.display = 'none';
  }
  var os = document.getElementById('id_operating_system').value;
  var pyGroup = document.getElementById('py-interpreter-group');
  var credGroup = document.getElementById('cred-group');
  var credSelect = document.getElementById('id_deployment_credential');
  var credWarning = document.getElementById('cred-warning');
  var linux = (os === 'RedHat' || os === 'Debian' || os === 'Linux');
  if (os === 'Windows') {
    pyGroup.style.display = 'none';
    // Solo credenciales con contraseña
    var hasValid = false;
    for (var i = 0; i < credSelect.options.length; i++) {
      var opt = credSelect.options[i];
      // Suponemos que las opciones inválidas tienen un atributo data-windows="0"
      if (opt.getAttribute('data-windows') === '1') {
        opt.style.display = '';
        hasValid = true;
      } else {
        opt.style.display = 'none';
      }
    }
    credWarning.style.display = hasValid ? 'none' : '';
    credWarning.textContent = hasValid ? '' : 'No hay credenciales con contraseña de Windows configurada.';
  } else {
    pyGroup.style.display = '';
    // Solo credenciales con llave SSH
    var hasValid = false;
    for (var i = 0; i < credSelect.options.length; i++) {
      var opt = credSelect.options[i];
      if (opt.getAttribute('data-ssh') === '1') {
        opt.style.display = '';
        hasValid = true;
      } else {
        opt.style.display = 'none';
      }
    }
    credWarning.style.display = hasValid ? 'none' : '';
    credWarning.textContent = hasValid ? '' : 'No hay credenciales con llave SSH configurada.';
  }
}
//document.getElementById('id_operating_system').removeEventListener('change', updateFormByOS);
//window.onload = updateFormByOS;
</script>
   <div class="form-group">
    {{ form.status.label_tag }} {{ form.status }}
   </div>
   <div class="form-group">
    {{ form.tags.label_tag }} {{ form.tags }}
   </div>
   <div class="form-group">
    {{ form.notes.label_tag }} {{ form.notes }}
   </div>
  <button type="submit" class="btn btn-primary">Guardar</button>
  <a href="{% url 'host_list' %}" class="btn btn-secondary">Cancelar</a>
</form>
<script>
  function filterGroups() {
    var environmentId = document.getElementById('id_environment').value;
    var groupSelect = document.getElementById('id_group');
    var options = groupSelect.options;
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      if (option.value === "") continue;
      option.style.display = option.getAttribute('data-environment-id') === environmentId ? 'block' : 'none';
    }
    if (groupSelect.selectedOptions.length && groupSelect.selectedOptions[0].style.display === 'none') {
      groupSelect.selectedIndex = 0;
    }
  }
  document.getElementById('id_environment').addEventListener('change', filterGroups);
  window.onload = filterGroups;
</script>
      </div>
    </div>
  </div>
  <script>
    function filterGroups() {
      var environmentId = document.getElementById('id_environment').value;
      var groupSelect = document.getElementById('id_group');
      var options = groupSelect.options;

      for (var i = 1; i < options.length; i++) {
        var option = options[i];
        option.style.display = option.getAttribute('data-environment-id') === environmentId ? 'block' : 'none';
      }
      groupSelect.selectedIndex = 0;
    }
    filterGroups();
  </script>
{% endblock %}
